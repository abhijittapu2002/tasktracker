<div class="row mb-3" *ngIf="selectedEmployee">
  <div class="col text-center">
    <h4>Tasks for <strong>{{ selectedEmployee }}</strong></h4>
  </div>
</div>

<div class="container-fluid kanban-container" [attr.inert]="isModalOpen ? true : null">
  <!-- Navigation header -->
  <div class="row mb-4">
    <div class="col-md-6">
      <button class="btn btn-outline-primary" routerLink="/admin/adminDashboard">
        <i class="fa fa-arrow-left me-1"></i> Back to Table View
      </button>
    </div>
    <div class="col-md-6 text-end">
      <button class="btn btn-success" (click)="openTaskModal()">
        <i class="fa fa-plus me-1"></i> Allocate Task
      </button>
    </div>
  </div>

  <!-- Kanban Board -->
  <div class="kanban-board" cdkDropListGroup>
    <div class="row">
      <!-- Pending Column -->
      <div class="col-md-3">
         <h5 style="color: red;">Pending</h5>
        <div class="kanban-column pending-column">
          <div class="column-header">
            <span class="badge bg-secondary">{{pendingTasks.length}}</span>
          </div>
          <div 
            cdkDropList 
            [cdkDropListData]="getCurrentPageTasks(pendingTasks, pendingPage)" 
            (cdkDropListDropped)="onDrop($event, 'pending')"
            class="task-list">
            <div *ngIf="pendingTasks.length === 0" class="empty-state">
              <i class="fa fa-inbox fa-2x mb-2"></i>
              <p>No pending tasks</p>
            </div>
            <div 
              *ngFor="let task of getCurrentPageTasks(pendingTasks, pendingPage)" 
              cdkDrag
              class="kanban-task-card">
              <div class="task-content" (dblclick)="openTaskModal(task)">
                <div class="task-header">
                  <span class="task-priority" [class]="getPriorityClass(task.priority)">
                    {{getPriorityText(task.priority)}}
                  </span>
                  <span class="task-id">#{{task.id}}</span>
                </div>
                <h6 class="task-title">{{ task.activity?.actName }}</h6>
                <p class="task-project">{{ task.activity?.project?.projName }}</p>
                <div class="task-assignee">
                  <i class="fa fa-user me-1"></i>
                  <span>{{ task.user?.username }}</span>
                </div>
                
                <div class="task-dates">
                  <div class="due-date">
                    <i class="fa fa-calendar me-1"></i>
                    <span>Due: {{ task.dueDate | date:'shortDate' }}</span>
                  </div>
                  <div class="end-date" *ngIf="task.endtime">
                    <i class="fa fa-flag-checkered me-1"></i>
                    <span>End: {{ task.endtime | date:'shortDate' }}</span>
                  </div>
                </div>
                
                <div class="task-actions">
                  <!-- View SubActivities Icon -->
                  <button class="btn btn-sm btn-outline-info me-1" title="View Function Points" 
                    (click)="viewSubActivities(task.activity.actId); $event.stopPropagation()">
                    <i class="fas fa-eye"></i>
                  </button>
                  
                  <button class="btn btn-sm btn-outline-success me-1" title="View Remarks" 
                    (click)="viewRemarks(task.activity.actId); $event.stopPropagation()">
                    <i class="fa fa-comment"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-primary" title="View File Details" 
                    (click)="viewFileDetails(task.activity.actId); $event.stopPropagation()">
                    <i class="fa fa-file"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Pagination for Pending Column -->
            <div class="pagination-controls" *ngIf="pendingTasks.length > 3">
              <button class="btn btn-sm btn-outline-secondary" 
                [disabled]="pendingPage === 0" 
                (click)="changePage('pending', -1)">
                <i class="fa fa-chevron-left"></i>
              </button>
              <span class="page-indicator">Page {{pendingPage + 1}} of {{getTotalPages(pendingTasks)}}</span>
              <button class="btn btn-sm btn-outline-secondary" 
                [disabled]="pendingPage >= getTotalPages(pendingTasks) - 1" 
                (click)="changePage('pending', 1)">
                <i class="fa fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="col-md-3">
        <h5 style="color: blue;">In Progress</h5>
        <div class="kanban-column progress-column">
          <div class="column-header">
            <span class="badge bg-primary">{{inProgressTasks.length}}</span>
          </div>
          <div 
            cdkDropList 
            [cdkDropListData]="getCurrentPageTasks(inProgressTasks, inProgressPage)" 
            (cdkDropListDropped)="onDrop($event, 'inProgress')"
            class="task-list">
            <div *ngIf="inProgressTasks.length === 0" class="empty-state">
              <i class="fa fa-cog fa-2x mb-2"></i>
              <p>No tasks in progress</p>
            </div>
            <div 
              *ngFor="let task of getCurrentPageTasks(inProgressTasks, inProgressPage)" 
              cdkDrag
              class="kanban-task-card">
              <div class="task-content" (dblclick)="openTaskModal(task)">
                <div class="task-header">
                  <span class="task-priority" [class]="getPriorityClass(task.priority)">
                    {{getPriorityText(task.priority)}}
                  </span>
                  <span class="task-id">#{{task.id}}</span>
                </div>
                <h6 class="task-title">{{ task.activity?.actName }}</h6>
                <p class="task-project">{{ task.activity?.project?.projName }}</p>
                <div class="task-assignee">
                  <i class="fa fa-user me-1"></i>
                  <span>{{ task.user?.username }}</span>
                </div>
                
                <div class="task-dates">
                  <div class="due-date">
                    <i class="fa fa-calendar me-1"></i>
                    <span>Due: {{ task.dueDate | date:'shortDate' }}</span>
                  </div>
                  <div class="end-date" *ngIf="task.endtime">
                    <i class="fa fa-flag-checkered me-1"></i>
                    <span>End: {{ task.endtime | date:'shortDate' }}</span>
                  </div>
                </div>
                
                <div class="task-actions">
                  <!-- View SubActivities Icon -->
                  <button class="btn btn-sm btn-outline-info me-1" title="View Function Points" 
                    (click)="viewSubActivities(task.activity.actId); $event.stopPropagation()">
                  <i class="fas fa-eye"></i>
                  </button>
                  
                  <button class="btn btn-sm btn-outline-success me-1" title="View Remarks" 
                    (click)="viewRemarks(task.activity.actId); $event.stopPropagation()">
                    <i class="fa fa-comment"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-primary" title="View File Details" 
                    (click)="viewFileDetails(task.activity.actId); $event.stopPropagation()">
                    <i class="fa fa-file"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Pagination for In Progress Column -->
            <div class="pagination-controls" *ngIf="inProgressTasks.length > 3">
              <button class="btn btn-sm btn-outline-secondary" 
                [disabled]="inProgressPage === 0" 
                (click)="changePage('inProgress', -1)">
                <i class="fa fa-chevron-left"></i>
              </button>
              <span class="page-indicator">Page {{inProgressPage + 1}} of {{getTotalPages(inProgressTasks)}}</span>
              <button class="btn btn-sm btn-outline-secondary" 
                [disabled]="inProgressPage >= getTotalPages(inProgressTasks) - 1" 
                (click)="changePage('inProgress', 1)">
                <i class="fa fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Completed Column -->
      <div class="col-md-3">
        <h5 style="color: green;">Completed</h5>
        <div class="kanban-column completed-column">
          <div class="column-header">
            <span class="badge bg-success">{{completedTasks.length}}</span>
          </div>
          <div 
            cdkDropList 
            [cdkDropListData]="getCurrentPageTasks(completedTasks, completedPage)" 
            (cdkDropListDropped)="onDrop($event, 'completed')"
            class="task-list">
            <div *ngIf="completedTasks.length === 0" class="empty-state">
              <i class="fa fa-check-circle fa-2x mb-2"></i>
              <p>No completed tasks</p>
            </div>
            <div 
              *ngFor="let task of getCurrentPageTasks(completedTasks, completedPage)" 
              cdkDrag
              class="kanban-task-card">
              <div class="task-content" (dblclick)="openTaskModal(task)">
                <div class="task-header">
                  <span class="task-priority" [class]="getPriorityClass(task.priority)">
                    {{getPriorityText(task.priority)}}
                  </span>
                  <span class="task-id">#{{task.id}}</span>
                </div>
                <h6 class="task-title">{{ task.activity?.actName }}</h6>
                <p class="task-project">{{ task.activity?.project?.projName }}</p>
                <div class="task-assignee">
                  <i class="fa fa-user me-1"></i>
                  <span>{{ task.user?.username }}</span>
                </div>
                
                <div class="task-dates">
                  <div class="due-date">
                    <i class="fa fa-calendar me-1"></i>
                    <span>Due: {{ task.dueDate | date:'shortDate' }}</span>
                  </div>
                  <div class="end-date" *ngIf="task.endtime">
                    <i class="fa fa-flag-checkered me-1"></i>
                    <span>End: {{ task.endtime | date:'shortDate' }}</span>
                  </div>
                </div>
                
                <div class="task-actions">
                  <!-- View SubActivities Icon -->
                  <button class="btn btn-sm btn-outline-info me-1" title="View Function Points" 
                    (click)="viewSubActivities(task.activity.actId); $event.stopPropagation()">
                    <i class="fas fa-eye"></i>
                  </button>
                  
                  <button class="btn btn-sm btn-outline-success me-1" title="View Remarks" 
                    (click)="viewRemarks(task.activity.actId); $event.stopPropagation()">
                    <i class="fa fa-comment"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-primary" title="View File Details" 
                    (click)="viewFileDetails(task.activity.actId); $event.stopPropagation()">
                    <i class="fa fa-file"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Pagination for Completed Column -->
            <div class="pagination-controls" *ngIf="completedTasks.length > 3">
              <button class="btn btn-sm btn-outline-secondary" 
                [disabled]="completedPage === 0" 
                (click)="changePage('completed', -1)">
                <i class="fa fa-chevron-left"></i>
              </button>
              <span class="page-indicator">Page {{completedPage + 1}} of {{getTotalPages(completedTasks)}}</span>
              <button class="btn btn-sm btn-outline-secondary" 
                [disabled]="completedPage >= getTotalPages(completedTasks) - 1" 
                (click)="changePage('completed', 1)">
                <i class="fa fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Deadline Panel Column -->
      <div class="col-md-3">
        <h5 style="color: orange">Upcoming Deadlines</h5>
        <div class="kanban-column deadline-column">
          <div class="column-header">
            <span class="badge bg-warning">{{upcomingDeadlines.length}}</span>
          </div>
          <div class="deadline-list">
            <div *ngIf="upcomingDeadlines.length === 0" class="empty-state">
              <i class="fa fa-calendar-check fa-2x mb-2"></i>
              <p>No upcoming deadlines</p>
            </div>
            <div *ngFor="let deadline of upcomingDeadlines" class="deadline-item">
              <div class="deadline-header">
                <span class="task-id">#{{deadline.id}}</span>
                <span class="days-left" [class]="getDaysLeftClass(deadline.daysLeft)">
                  {{ deadline.daysLeft }} days
                </span>
              </div>
              <h6 class="deadline-title">{{ deadline.activity?.actName }}</h6>
              <p class="deadline-project">{{ deadline.activity?.project?.projName }}</p>
              <div class="deadline-assignee">
                <i class="fa fa-user me-1"></i>
                <span>{{ deadline.user?.username }}</span>
              </div>
              <div class="deadline-date">
                <i class="fa fa-hourglass-half me-1"></i>
                <span>{{ deadline.dueDate | date:'mediumDate' }}</span>
              </div>
              <div class="deadline-status">
                <span class="badge" [ngClass]="{
                  'bg-secondary': deadline.status?.sttStatus?.toLowerCase().includes('pending'),
                  'bg-primary': deadline.status?.sttStatus?.toLowerCase().includes('progress'),
                  'bg-success': deadline.status?.sttStatus?.toLowerCase().includes('complete')
                }">
                  {{ deadline.status?.sttStatus }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SubActivity Modal -->
<div class="modal fade" id="subActivityModal" tabindex="-1" aria-labelledby="subActivityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="subActivityModalLabel">
          <i class="fas fa-list me-2"></i>Function Points for Activity ID: {{ selectedActivityId }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Performance Dashboard -->
        <div class="performance-dashboard" *ngIf="performanceData">
          <div class="circular-progress" [style.--percentage]="performanceData.weightagePercentage">
            <svg>
              <circle r="45" cx="50" cy="50"></circle>
              <circle r="45" cx="50" cy="50" 
                  [style.stroke]="getProgressColor(performanceData.weightagePercentage)"></circle>
            </svg>
            <div class="progress-text">
              <div class="progress-value">{{ performanceData.weightagePercentage }}%</div>
              <div class="progress-label">Completed</div>
            </div>
          </div>
          
          <div class="stats-container">
            <div class="stat-box">
              <div class="stat-value">{{ performanceData.totalSubActivities }}</div>
              <div class="stat-label">Total Function Points</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">{{ performanceData.completedSubActivities }}</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">{{ performanceData.totalSubActivities - performanceData.completedSubActivities }}</div>
              <div class="stat-label">Pending</div>
            </div>
          </div>
        </div>

        <!-- Add SubActivity Button -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">Function Point List</h6>
          <button class="btn btn-sm btn-success" (click)="showSubActivityForm()">
            <i class="fas fa-plus-circle me-1"></i>Add Function Point
          </button>
        </div>

        <!-- SubActivity Form -->
        <div class="subactivity-form-container" *ngIf="showSubActivityFormFlag">
          <h6 class="mb-3"><i class="fas fa-plus-circle me-2"></i>{{ selectedSubActivity ? 'Edit Function Point' : 'Create New Function Point' }}</h6>
          <form [formGroup]="subActivityForm" (ngSubmit)="submitSubActivityForm()">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label small text-muted">Function Point Name</label>
                <input type="text" class="form-control" formControlName="subActName" required>
              </div>
              <div class="col-md-4">
                <label class="form-label small text-muted">Description</label>
                <input type="text" class="form-control" formControlName="subActDesc">
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted">Status</label>
                <select class="form-select" formControlName="status">
                  <option value="PENDING">Pending</option>
                  <option value="IN_PROGRESS">In Progress</option>
                  <option value="COMPLETED">Completed</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted">Start Date</label>
                <input type="datetime-local" class="form-control" formControlName="startDate">
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted">End Date</label>
                <input type="datetime-local" class="form-control" formControlName="endDate">
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12 d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="fas fa-save me-1"></i>{{ selectedSubActivity ? 'Update' : 'Create' }}
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelSubActivityForm()">
                  Cancel
                </button>
              </div>
            </div>
          </form>
        </div>

        <!-- SubActivities Table -->
        <div *ngIf="subActivities.length === 0 && !showSubActivityFormFlag" class="text-center py-4">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <p class="text-muted">No function points found for this activity.</p>
        </div>
        
        <div *ngIf="subActivities.length > 0" class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th class="fw-bold">ID</th>
                <th class="fw-bold">Function Point Name</th>
                <th class="fw-bold">Description</th>
                <th class="fw-bold">Status</th>
                <th class="fw-bold">Start Date</th>
                <th class="fw-bold">End Date</th>
                <th class="fw-bold">Created By</th>
                <th class="fw-bold">Created At</th>
                <th class="fw-bold text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let subActivity of subActivities" (dblclick)="onEditSubActivity(subActivity)" class="cursor-pointer">
                <td class="text-muted">{{ subActivity.subActId }}</td>
                <td class="fw-semibold">{{ subActivity.subActName }}</td>
                <td>{{ subActivity.subActDesc }}</td>
                <td>
                  <span class="badge" 
                        [ngClass]="{
                          'bg-secondary': subActivity.status === 'PENDING',
                          'bg-warning': subActivity.status === 'IN_PROGRESS',
                          'bg-success': subActivity.status === 'COMPLETED'
                        }">
                    {{ subActivity.status }}
                  </span>
                </td>
                <td>{{ formatDate(subActivity.startDate) }}</td>
                <td>{{ formatDate(subActivity.endDate) }}</td>
                <td>{{ subActivity.createdBy }}</td>
                <td>{{ formatDate(subActivity.createdAt) }}</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-danger" 
                          (click)="deleteSubActivity(subActivity.subActId)">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>